<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Upload Scan | DigiShield</title>
  <link rel="stylesheet" href="scan.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <nav class="navbar">
    <span class="logo-text"><span class="logo-icon">üõ°Ô∏è</span>DIGI SHIELD</span>
    <div class="nav-links">
      <a href="dashboard.html">Dashboard</a>
      <a href="alerts.html">Alerts</a>
      <a href="flagged.html">Flagged</a>
      <a href="settings.html">Settings</a>
    </div>
  </nav>

  <aside class="dashboard-sidebar">
    <a href="overview.html">
      <div class="sidebar-icon-container">
        <i class="fa-solid fa-house sidebar-icon"></i>
      </div>
      Overview
    </a>
    <a href="scan_img.html" class="active">
      <div class="sidebar-icon-container">
        <i class="fa-solid fa-cloud-arrow-up sidebar-icon"></i>
      </div>
      Upload Scan
    </a>
    <a href="alert_history.html">
      <div class="sidebar-icon-container">
        <i class="fa-solid fa-clock-rotate-left sidebar-icon"></i>
      </div>
      Alert History
    </a>
    <a href="support.html">
      <div class="sidebar-icon-container">
        <i class="fa-solid fa-comments sidebar-icon"></i>
      </div>
      Support
    </a>
  </aside>

  <div class="upload-scan-container">
    <header class="page-header">
      <h1 class="page-title">
        <i class="fa-solid fa-shield-halved"></i>
        File Security Scan
      </h1>
      <p class="page-subtitle">Upload your files for comprehensive security analysis</p>
    </header>

    <div class="scan-mascot">
      <img src="https://i.pinimg.com/736x/a2/a2/c6/a2a2c61877253fda98837fdb85e47769.jpg" alt="DigiShield Mascot" class="mascot-image" />
      <div class="mascot-bubble">
        Hi! I'm Digi, your digital security guardian.<br>
        Drop your file here and I'll scan it thoroughly for any threats!
      </div>
    </div>

    <form id="scanForm" class="upload-form">
      <div class="file-drop-zone" id="dropZone">
        <input type="file" id="scanFile" name="scanFile" accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.txt,.zip" required class="file-input">
        <div class="upload-icon">
          <i class="fa-solid fa-cloud-arrow-up"></i>
        </div>
        <div class="upload-text">Drop your file here or click to browse</div>
        <div class="upload-subtext">Maximum file size: 10MB</div>
        <div class="file-types">
          <span class="file-type">JPG</span>
          <span class="file-type">PNG</span>
          <span class="file-type">PDF</span>
          <span class="file-type">DOC</span>
          <span class="file-type">TXT</span>
          <span class="file-type">ZIP</span>
        </div>
      </div>

      <div id="filePreview" class="file-preview">
        <img id="previewImg" class="preview-image" style="display:none;">
        <div id="fileInfo" class="file-info" style="display:none;">
          <div id="fileName" class="file-name"></div>
          <div id="fileSize" class="file-size"></div>
        </div>
      </div>

      <button type="submit" class="scan-button" id="scanBtn">
        <i class="fa-solid fa-magnifying-glass"></i>
        Start Security Scan
      </button>
    </form>

    <div id="scanProgress" class="scan-progress">
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-bar-fill" id="progressFill"></div>
        </div>
      </div>
      <div class="progress-text">
        <div class="progress-spinner"></div>
        <span id="progressText">Initializing scan...</span>
      </div>
    </div>

    <div id="scanResult" class="scan-result"></div>
  </div>

  <script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('scanFile');
    const filePreview = document.getElementById('filePreview');
    const previewImg = document.getElementById('previewImg');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const scanForm = document.getElementById('scanForm');
    const scanBtn = document.getElementById('scanBtn');
    const scanProgress = document.getElementById('scanProgress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const scanResult = document.getElementById('scanResult');

    function formatFileSize(bytes) {
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return parseFloat((bytes / Math.pow(1024, i)).toFixed(2)) + ' ' + sizes[i];
    }

    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        fileInput.files = files;
        handleFileSelect(files[0]);
      }
    });

    fileInput.addEventListener('change', e => {
      if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
      }
    });

    function handleFileSelect(file) {
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
      fileInfo.style.display = 'block';
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = e => {
          previewImg.src = e.target.result;
          previewImg.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        previewImg.style.display = 'none';
      }
      filePreview.classList.add('show');
    }

    scanForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = fileInput.files[0];
      if (!file) return showResult('Please select a file.', 'error');

      if (file.size > 10 * 1024 * 1024) {
        return showResult('File size exceeds 10MB.', 'error');
      }

      scanResult.classList.remove('show');
      scanProgress.classList.add('show');
      scanBtn.disabled = true;
      progressText.textContent = 'Starting scan...';
      progressFill.style.width = '20%';

      if (file.name.endsWith('.txt')) {
        const text = await file.text();
        const sentences = text.split(/\n+/).map(t => t.trim()).filter(Boolean);
        progressText.textContent = 'Sending to toxicity engine...';
        progressFill.style.width = '50%';

        try {
          const res = await fetch("http://127.0.0.1:5000/analyze_batch", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ texts: sentences, url: window.location.href })
          });
          const result = await res.json();
          progressFill.style.width = '100%';

          const toxicSentences = result.filter(r => r.label === 'toxic');
          if (toxicSentences.length > 0) {
            showResult(`‚ö†Ô∏è ${toxicSentences.length} toxic sentence(s) found.<br><em>Example:</em> "${toxicSentences[0].text}"`, 'warning');
          } else {
            showResult('‚úÖ No toxic content detected in file.', 'success');
          }
        } catch (err) {
          console.error(err);
          showResult('‚ö†Ô∏è Error contacting server.', 'error');
        }

      } else {
        const steps = [
          { text: 'Scanning for threats...', width: 50, delay: 600 },
          { text: 'Analyzing file metadata...', width: 80, delay: 700 },
          { text: 'Scan complete.', width: 100, delay: 500 }
        ];
        let i = 0;
        const runSteps = () => {
          if (i >= steps.length) return showResult('‚úÖ File is clean and safe to use.', 'success');
          const step = steps[i];
          progressText.textContent = step.text;
          progressFill.style.width = `${step.width}%`;
          i++;
          setTimeout(runSteps, step.delay);
        };
        runSteps();
      }

      scanProgress.classList.remove('show');
      scanBtn.disabled = false;
    });

    function showResult(message, type) {
      scanResult.className = `scan-result ${type} show`;
      scanResult.innerHTML = `
        <div>
          <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-times-circle'} result-icon"></i>
          <div class="result-text">${message}</div>
        </div>
      `;
    }
  </script>

  <style>
    .scan-result {
      margin-top: 20px;
      font-family: Poppins, sans-serif;
      font-size: 16px;
    }

    .scan-result.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      padding: 12px 20px;
      border-radius: 6px;
    }

    .scan-result.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
      padding: 12px 20px;
      border-radius: 6px;
    }

    .scan-result.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      padding: 12px 20px;
      border-radius: 6px;
    }

    .scan-result .result-text {
      margin-top: 8px;
      line-height: 1.5;
    }

    .scan-result i {
      font-size: 20px;
      margin-right: 10px;
      vertical-align: middle;
    }
  </style>
</body>
</html>
